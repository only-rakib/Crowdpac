{% extends 'header_footer.html' %} {% load static %}
{% block title %}
<script src="//cdn.ckeditor.com/4.14.1/basic/ckeditor.js"></script>
<link rel="stylesheet" type="text/css" href="{%static 'css/tagsinput.css'%}">
<title>New Petition | Crowdpac | Crowdpac</title>
{% endblock title %} {% block container %}
<div class="container">
    <div class="row">
        <div class="col-10 offset-1">
            <div class="row" style="margin-top: 3rem">
                <div class="col text-center">
                    <img src="{%static 'svg/document.svg'%}">
                </div>
            </div>
            <div class="row" style="margin-top: 1rem">
                <div class="col text-center">
                    <h2 class="title3">Start A Petition</h2>
                </div>
            </div>
            <div class="row" style="margin-top: 3rem">
                <div class="col">
                    <div class="row">
                        <div class="col">
                            <label style="float: left;">Petition Title</label>
                            <label class="mini-recipient" style="float: right;">
                                Required</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <input type="text" name="campaign_title" id="campaign_title_id" maxlength="75" style="width: 100%" placeholder="E.g. Former Marine to Reform VA">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <span class="mini-recipient" id="campaign_title_remainchar">75/75 characters remaining.</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row" style="margin-top: 3rem">
                <div class="col">
                    <div class="row">
                        <div class="col">
                            <label style="float: left;">Your Petition Story</label>
                            <label class="mini-recipient" style="float: right;">
                                Required</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <textarea name="editor" id="editor" placeholder="What do petitioners need to know ? All petitioners will see this story so it's important to craft a very good one!"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row" style="margin-top: 3rem">
                <div class="col">
                    <div class="row">
                        <div class="col">
                            <label style="float: left;">
                                Petition Image</label>
                            <label class="mini-recipient" style="float: right;">
                                Required</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col mini-recipient">
                            Select an image from your computer, drag to position it, and use the slider to adjust the zoom. We recommend using a JPEG or PNG that's at least 1240 pixels wide by 740 pixels tall.
                        </div>
                    </div>
                    <div class="row" style="margin-top: .8rem">
                        <div class="col" style="background: #F6F6F6;border-radius: 5px;">
                            <div style="border:1px solid #F6F6F6;padding: 3rem 3rem;">
                                <div style="width: 100%;height: 30vw;border:1px solid #cccccc;text-align: center;align-content: center;border-radius: 5px;">
                                    <img id="campaignImage" src="#" style="width: 100%;height: 100%;color: transparent;" alt=".">
                                    <button type="button" class="btnr" id="upfile1" style="margin-top: 15vw">
                                        Select an Image
                                    </button>
                                    <input type="file" accept="image/jpeg,image/png" id="file1" name="file1" style="display:none" />
                                    <button type="button" class="btnr" id="removefile" style="display:none;float:right;margin-top: .8rem">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row" style="margin-top: 3rem">
                <div class="col">
                    <div class="row">
                        <div class="col">
                            <label style="float: left;">
                                Issues</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label class="mini-recipient">Let petition signers know what you care about by tagging your petition with up to 5 issues.</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-1" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/campaign_finace.svg'%}">Campaign Finance Reform</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-2" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/civilRight.svg'%}">Civil Rights</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-3" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/Climate Change.svg'%}">Climate Change</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-4" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/Criminal Justice Reform.svg'%}">Criminal Justice Reform</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-5" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/Environment.svg'%}">Environment</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-6" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/Gender Equality.svg'%}">Gender Equality</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-7" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/Gun Safety.svg'%}">Gun Safety</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-8" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/Health Care.svg'%}">Health Care</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-9" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/Immigration Reform.svg'%}">Immigration Reform</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-10" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/Income Inequality.svg'%}">Income Inequality</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-11" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/International Diplomacy.svg'%}">International Diplomacy</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-12" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/Internet Policy.svg'%}">Internet Policy</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-13" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/LGBTQ Rights.svg'%}">LGBTQ Rights</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-14" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/Marijuana Legalization.svg'%}">Marijuana Legalization</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-15" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/Pro Choice.svg'%}">Pro Choice</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-16" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/Public Education.svg'%}">Public Education</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-17" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/Transport Infrastructure.svg'%}">Transport Infrastructure</button>
                        </div>
                        <div class="col-4" style="margin-top: 1rem">
                            <button onclick="tagSelect(this.id)" class="btnr btnr-light-not-hover" id="tag-18" style="border-radius:50px;height: 100%;width:100%"><img src="{%static 'svg/Union Rights.svg'%}">Union Rights</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row" style="margin-top: 1rem">
                <div class="col">
                    <div class="row">
                        <div class="col">
                            <input type="text" name="tags_text" data-role="tagsinput" id="tags_text" class="form-control" placeholder="+ Add your own">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <span id="optionsleft" class="mini-recipient">
                                0/5 selected
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row" style="margin-top: 6rem">
                <div class="col text-center">
                    <button type="button" class="btnr red campaigns" onclick="optionalSettingsSave()">
                        Submit Your Petition
                    </button>
                    <p class="mini-recipient text-center">
                        Title, description, and image must be filled out in order to submit your petition.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
CKEDITOR.replace('editor');
$("#upfile1").click(function() {
    $("#file1").trigger('click');
});

function readURL(input) {
    console.log(input.id);
    if (input.id == "file1") {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#campaignImage').attr('src', e.target.result);
                if (e.target.result != null) {
                    $('#upfile1').hide();
                    $('#removefile').show();
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    } else if (input.id == "file3") {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#candidate_head_shot').attr('src', e.target.result);
                if (e.target.result != null) {
                    $('#upfile3').hide();
                    $('#removefile3').show();
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
}
$("#file1").change(function() {
    readURL(this);
});
$("#removefile").click(function() {
    $('#campaignImage').attr('src', "");
    $('#upfile1').show();
    $('#removefile').hide();
});
$("#campaign_title_id").keyup(function() {
    campaign_title_pressed = false;
    var trig = this.value.length;
    var a = 75 - trig;
    a = a.toString();
    trig++;
    $("#campaign_title_remainchar").text(a + "/75 characters remaining.");
});
window.tagsCounts = 0;
var store = 0;
var total_tags = 0;

function tagSelect(clicked_id) {

    var r = ("#" + clicked_id).toString();
    //console.log(r);
    //var tags = document.getElementById(clicked_id);
    if (total_tags < 5) {

        if ($(r).hasClass("classActiveIssue")) {

            $(r).removeClass("classActiveIssue");
            window.tagsCounts--;
            //alert("--");
        } else {
            $(r).addClass("classActiveIssue");
            window.tagsCounts++;
            //alert("++");
            //console.log($(r));
        }


    } else {

        if ($(r).hasClass("classActiveIssue")) {
            $(r).removeClass("classActiveIssue");
            window.tagsCounts--;
        }
    }
    total_tags = store + tagsCounts;
    $("#optionsleft").text(total_tags + "/5 selected");
}
$('#tags_text').on('change', function(event) {
    var items = $("#tags_text").tagsinput('items').length;
    store = items;
    total_tags = store + tagsCounts;
    $("#optionsleft").text(total_tags + "/5 selected");
    //console.log(total_tags);
    return false;

});



function optionalSettingsSave() {
    if ($("#campaign_title_id").val() === "" || CKEDITOR.instances.editor.getData() === "" || $('#campaignImage').attr('src') === "") {
        alert("Fill the required items");

    } else {
        var tagButton = [];
        $('.classActiveIssue').each(function() {
            tagButton.push(this.id);
        });
        var tagText = $("#tags_text").tagsinput('items');
        var tagselected = [];
        for (var i = 0; i < tagText.length; i++) {
            tagselected.push(tagText[i]);
        }
        for (var i = 0; i < tagButton.length; i++) {
            tagselected.push(tagButton[i]);
        }

        datas = {
            'tagselected': tagselected,
            'petition_title': $("#campaign_title_id").val(),
            'petition_story': CKEDITOR.instances.editor.getData(),
            'petition_img': $('#campaignImage').attr('src'),

        }
        $.ajax({
            type: "POST",
            url: "{% url 'start_petition' %}",
            dataType: 'json',
            data: {
                //'story': $("#pro_name").text(),
                'start_petition': JSON.stringify(datas),
            },
            success:function(){
                location.href = "{% url 'home' %}"
            }

        });
    }

}

(function($) {
    "use strict";
    //console.log("paisi", window.tagsCount);
    var defaultOptions = {
        tagClass: function(item) {
            return 'badge badge-info';
        },
        focusClass: 'focus',
        itemValue: function(item) {
            return item ? item.toString() : item;
        },
        itemText: function(item) {
            return this.itemValue(item);
        },
        itemTitle: function(item) {
            return null;
        },
        freeInput: true,
        addOnBlur: true,
        maxTags: 5,
        maxChars: undefined,
        confirmKeys: [13, 44],
        delimiter: ',',
        delimiterRegex: null,
        cancelConfirmKeysOnEmpty: false,
        onTagExists: function(item, $tag) {
            $tag.hide().fadeIn();
        },
        trimValue: false,
        allowDuplicates: false,
        triggerChange: true,
        editOnBackspace: false,

    };

    /**
     * Constructor function
     */
    function TagsInput(element, options) {

        this.isInit = true;
        this.itemsArray = [];

        this.$element = $(element);
        this.$element.addClass('sr-only');

        this.isSelect = (element.tagName === 'SELECT');
        this.multiple = (this.isSelect && element.hasAttribute('multiple'));
        this.objectItems = options && options.itemValue;
        this.placeholderText = element.hasAttribute('placeholder') ? this.$element.attr('placeholder') : '';
        this.inputSize = Math.max(1, this.placeholderText.length);

        this.$container = $('<div class="bootstrap-tagsinput"></div>');
        this.$input = $('<input type="text" placeholder="' + this.placeholderText + '"/>').appendTo(this.$container);

        this.$element.before(this.$container);

        this.build(options);
        this.isInit = false;
    }

    TagsInput.prototype = {
        constructor: TagsInput,

        /**
         * Adds the given item as a new tag. Pass true to dontPushVal to prevent
         * updating the elements val()
         */
        add: function(item, dontPushVal, options) {
            var self = this;
            //console.log("yoo",window.tagsCount);
            self.options.maxTags = 5 - window.tagsCounts;
            if (self.options.maxTags && self.itemsArray.length >= self.options.maxTags)
                return;

            // Ignore falsey values, except false
            if (item !== false && !item)
                return;

            // Trim value
            if (typeof item === "string" && self.options.trimValue) {
                item = $.trim(item);
            }

            // Throw an error when trying to add an object while the itemValue option was not set
            if (typeof item === "object" && !self.objectItems)
                throw ("Can't add objects when itemValue option is not set");

            // Ignore strings only containg whitespace
            if (item.toString().match(/^\s*$/))
                return;

            // If SELECT but not multiple, remove current tag
            if (self.isSelect && !self.multiple && self.itemsArray.length > 0)
                self.remove(self.itemsArray[0]);

            if (typeof item === "string" && this.$element[0].tagName === 'INPUT') {
                var delimiter = (self.options.delimiterRegex) ? self.options.delimiterRegex : self.options.delimiter;
                var items = item.split(delimiter);
                if (items.length > 1) {
                    for (var i = 0; i < items.length; i++) {
                        this.add(items[i], true);
                    }

                    if (!dontPushVal)
                        self.pushVal(self.options.triggerChange);
                    return;
                }
            }

            var itemValue = self.options.itemValue(item),
                itemText = self.options.itemText(item),
                tagClass = self.options.tagClass(item),
                itemTitle = self.options.itemTitle(item);

            // Ignore items allready added
            var existing = $.grep(self.itemsArray, function(item) { return self.options.itemValue(item) === itemValue; })[0];
            if (existing && !self.options.allowDuplicates) {
                // Invoke onTagExists
                if (self.options.onTagExists) {
                    var $existingTag = $(".badge", self.$container).filter(function() { return $(this).data("item") === existing; });
                    self.options.onTagExists(item, $existingTag);
                }
                return;
            }

            // if length greater than limit
            if (self.items().toString().length + item.length + 1 > self.options.maxInputLength)
                return;

            // raise beforeItemAdd arg
            var beforeItemAddEvent = $.Event('beforeItemAdd', { item: item, cancel: false, options: options });
            self.$element.trigger(beforeItemAddEvent);
            if (beforeItemAddEvent.cancel)
                return;

            // register item in internal array and map
            self.itemsArray.push(item);

            // add a tag element

            var $tag = $('<span class="' + htmlEncode(tagClass) + (itemTitle !== null ? ('" title="' + itemTitle) : '') + '">' + htmlEncode(itemText) + '<span data-role="remove"></span></span>');
            $tag.data('item', item);
            self.findInputWrapper().before($tag);

            // Check to see if the tag exists in its raw or uri-encoded form
            var optionExists = (
                $('option[value="' + encodeURIComponent(itemValue).replace(/"/g, '\\"') + '"]', self.$element).length ||
                $('option[value="' + htmlEncode(itemValue).replace(/"/g, '\\"') + '"]', self.$element).length
            );

            // add <option /> if item represents a value not present in one of the <select />'s options
            if (self.isSelect && !optionExists) {
                var $option = $('<option selected>' + htmlEncode(itemText) + '</option>');
                $option.data('item', item);
                $option.attr('value', itemValue);
                self.$element.append($option);
            }

            if (!dontPushVal)
                self.pushVal(self.options.triggerChange);

            // Add class when reached maxTags
            if (self.options.maxTags === self.itemsArray.length || self.items().toString().length === self.options.maxInputLength)
                self.$container.addClass('bootstrap-tagsinput-max');

            // If using typeahead, once the tag has been added, clear the typeahead value so it does not stick around in the input.
            if ($('.typeahead, .twitter-typeahead', self.$container).length) {
                self.$input.typeahead('val', '');
            }

            if (this.isInit) {
                self.$element.trigger($.Event('itemAddedOnInit', { item: item, options: options }));
            } else {
                self.$element.trigger($.Event('itemAdded', { item: item, options: options }));
            }
        },

        /**
         * Removes the given item. Pass true to dontPushVal to prevent updating the
         * elements val()
         */
        remove: function(item, dontPushVal, options) {
            var self = this;

            if (self.objectItems) {
                if (typeof item === "object")
                    item = $.grep(self.itemsArray, function(other) { return self.options.itemValue(other) == self.options.itemValue(item); });
                else
                    item = $.grep(self.itemsArray, function(other) { return self.options.itemValue(other) == item; });

                item = item[item.length - 1];
            }

            if (item) {
                var beforeItemRemoveEvent = $.Event('beforeItemRemove', { item: item, cancel: false, options: options });
                self.$element.trigger(beforeItemRemoveEvent);
                if (beforeItemRemoveEvent.cancel)
                    return;

                $('.badge', self.$container).filter(function() { return $(this).data('item') === item; }).remove();
                $('option', self.$element).filter(function() { return $(this).data('item') === item; }).remove();
                if ($.inArray(item, self.itemsArray) !== -1)
                    self.itemsArray.splice($.inArray(item, self.itemsArray), 1);
            }

            if (!dontPushVal)
                self.pushVal(self.options.triggerChange);

            // Remove class when reached maxTags
            if (self.options.maxTags > self.itemsArray.length)
                self.$container.removeClass('bootstrap-tagsinput-max');

            self.$element.trigger($.Event('itemRemoved', { item: item, options: options }));
        },

        /**
         * Removes all items
         */
        removeAll: function() {
            var self = this;

            $('.badge', self.$container).remove();
            $('option', self.$element).remove();

            while (self.itemsArray.length > 0)
                self.itemsArray.pop();

            self.pushVal(self.options.triggerChange);
        },

        /**
         * Refreshes the tags so they match the text/value of their corresponding
         * item.
         */
        refresh: function() {
            var self = this;
            $('.badge', self.$container).each(function() {
                var $tag = $(this),
                    item = $tag.data('item'),
                    itemValue = self.options.itemValue(item),
                    itemText = self.options.itemText(item),
                    tagClass = self.options.tagClass(item);

                // Update tag's class and inner text
                $tag.attr('class', null);
                $tag.addClass('badge ' + htmlEncode(tagClass));
                $tag.contents().filter(function() {
                    return this.nodeType == 3;
                })[0].nodeValue = htmlEncode(itemText);

                if (self.isSelect) {
                    var option = $('option', self.$element).filter(function() { return $(this).data('item') === item; });
                    option.attr('value', itemValue);
                }
            });
        },

        /**
         * Returns the items added as tags
         */
        items: function() {
            return this.itemsArray;
        },

        /**
         * Assembly value by retrieving the value of each item, and set it on the
         * element.
         */
        pushVal: function() {
            var self = this,
                val = $.map(self.items(), function(item) {
                    return self.options.itemValue(item).toString();
                });

            self.$element.val(val.join(self.options.delimiter));

            if (self.options.triggerChange)
                self.$element.trigger('change');
        },

        /**
         * Initializes the tags input behaviour on the element
         */
        build: function(options) {
            var self = this;

            self.options = $.extend({}, defaultOptions, options);
            // When itemValue is set, freeInput should always be false
            if (self.objectItems)
                self.options.freeInput = false;

            makeOptionItemFunction(self.options, 'itemValue');
            makeOptionItemFunction(self.options, 'itemText');
            makeOptionFunction(self.options, 'tagClass');

            // Typeahead Bootstrap version 2.3.2
            if (self.options.typeahead) {
                var typeahead = self.options.typeahead || {};

                makeOptionFunction(typeahead, 'source');

                self.$input.typeahead($.extend({}, typeahead, {
                    source: function(query, process) {
                        function processItems(items) {
                            var texts = [];

                            for (var i = 0; i < items.length; i++) {
                                var text = self.options.itemText(items[i]);
                                map[text] = items[i];
                                texts.push(text);
                            }
                            process(texts);
                        }

                        this.map = {};
                        var map = this.map,
                            data = typeahead.source(query);

                        if ($.isFunction(data.success)) {
                            // support for Angular callbacks
                            data.success(processItems);
                        } else if ($.isFunction(data.then)) {
                            // support for Angular promises
                            data.then(processItems);
                        } else {
                            // support for functions and jquery promises
                            $.when(data)
                                .then(processItems);
                        }
                    },
                    updater: function(text) {
                        self.add(this.map[text]);
                        return this.map[text];
                    },
                    matcher: function(text) {
                        return (text.toLowerCase().indexOf(this.query.trim().toLowerCase()) !== -1);
                    },
                    sorter: function(texts) {
                        return texts.sort();
                    },
                    highlighter: function(text) {
                        var regex = new RegExp('(' + this.query + ')', 'gi');
                        return text.replace(regex, "<strong>$1</strong>");
                    }
                }));
            }

            // typeahead.js
            if (self.options.typeaheadjs) {
                // Determine if main configurations were passed or simply a dataset
                var typeaheadjs = self.options.typeaheadjs;
                if (!$.isArray(typeaheadjs)) {
                    typeaheadjs = [null, typeaheadjs];
                }

                $.fn.typeahead.apply(self.$input, typeaheadjs).on('typeahead:selected', $.proxy(function(obj, datum, name) {
                    var index = 0;
                    typeaheadjs.some(function(dataset, _index) {
                        if (dataset.name === name) {
                            index = _index;
                            return true;
                        }
                        return false;
                    });

                    // @TODO Dep: https://github.com/corejavascript/typeahead.js/issues/89
                    if (typeaheadjs[index].valueKey) {
                        self.add(datum[typeaheadjs[index].valueKey]);
                    } else {
                        self.add(datum);
                    }

                    self.$input.typeahead('val', '');
                }, self));
            }

            self.$container.on('click', $.proxy(function(event) {
                if (!self.$element.attr('disabled')) {
                    self.$input.removeAttr('disabled');
                }
                self.$input.focus();
            }, self));

            if (self.options.addOnBlur && self.options.freeInput) {
                self.$input.on('focusout', $.proxy(function(event) {
                    // HACK: only process on focusout when no typeahead opened, to
                    //       avoid adding the typeahead text as tag
                    if ($('.typeahead, .twitter-typeahead', self.$container).length === 0) {
                        self.add(self.$input.val());
                        self.$input.val('');
                    }
                }, self));
            }

            // Toggle the 'focus' css class on the container when it has focus
            self.$container.on({
                focusin: function() {
                    self.$container.addClass(self.options.focusClass);
                },
                focusout: function() {
                    self.$container.removeClass(self.options.focusClass);
                },
            });

            self.$container.on('keydown', 'input', $.proxy(function(event) {
                var $input = $(event.target),
                    $inputWrapper = self.findInputWrapper();

                if (self.$element.attr('disabled')) {
                    self.$input.attr('disabled', 'disabled');
                    return;
                }

                switch (event.which) {
                    // BACKSPACE
                    case 8:
                        if (doGetCaretPosition($input[0]) === 0) {
                            var prev = $inputWrapper.prev();
                            if (prev.length) {
                                if (self.options.editOnBackspace === true) {
                                    $input.val(prev.data('item'));
                                }
                                self.remove(prev.data('item'));
                            }
                        }
                        break;

                        // DELETE
                    case 46:
                        if (doGetCaretPosition($input[0]) === 0) {
                            var next = $inputWrapper.next();
                            if (next.length) {
                                self.remove(next.data('item'));
                            }
                        }
                        break;

                        // LEFT ARROW
                    case 37:
                        // Try to move the input before the previous tag
                        var $prevTag = $inputWrapper.prev();
                        if ($input.val().length === 0 && $prevTag[0]) {
                            $prevTag.before($inputWrapper);
                            $input.focus();
                        }
                        break;
                        // RIGHT ARROW
                    case 39:
                        // Try to move the input after the next tag
                        var $nextTag = $inputWrapper.next();
                        if ($input.val().length === 0 && $nextTag[0]) {
                            $nextTag.after($inputWrapper);
                            $input.focus();
                        }
                        break;
                    default:
                        // ignore
                }

                // Reset internal input's size
                var textLength = $input.val().length,
                    wordSpace = Math.ceil(textLength / 5),
                    size = textLength + wordSpace + 1;
                $input.attr('size', Math.max(this.inputSize, size));
            }, self));

            self.$container.on('keypress', 'input', $.proxy(function(event) {
                var $input = $(event.target);

                if (self.$element.attr('disabled')) {
                    self.$input.attr('disabled', 'disabled');
                    return;
                }

                var text = $input.val(),
                    maxLengthReached = self.options.maxChars && text.length >= self.options.maxChars;
                if (self.options.freeInput && (keyCombinationInList(event, self.options.confirmKeys) || maxLengthReached)) {
                    // Only attempt to add a tag if there is data in the field
                    if (text.length !== 0) {
                        self.add(maxLengthReached ? text.substr(0, self.options.maxChars) : text);
                        $input.val('');
                    }

                    // If the field is empty, let the event triggered fire as usual
                    if (self.options.cancelConfirmKeysOnEmpty === false) {
                        event.preventDefault();
                    }
                }

                // Reset internal input's size
                var textLength = $input.val().length,
                    wordSpace = Math.ceil(textLength / 5),
                    size = textLength + wordSpace + 1;
                $input.attr('size', Math.max(this.inputSize, size));
            }, self));

            // Remove icon clicked
            self.$container.on('click', '[data-role=remove]', $.proxy(function(event) {
                if (self.$element.attr('disabled')) {
                    return;
                }
                self.remove($(event.target).closest('.badge').data('item'));
            }, self));

            // Only add existing value as tags when using strings as tags
            if (self.options.itemValue === defaultOptions.itemValue) {
                if (self.$element[0].tagName === 'INPUT') {
                    self.add(self.$element.val());
                } else {
                    $('option', self.$element).each(function() {
                        self.add($(this).attr('value'), true);
                    });
                }
            }
        },

        /**
         * Removes all tagsinput behaviour and unregsiter all event handlers
         */
        destroy: function() {
            var self = this;

            // Unbind events
            self.$container.off('keypress', 'input');
            self.$container.off('click', '[role=remove]');

            self.$container.remove();
            self.$element.removeData('tagsinput');
            self.$element.show();
        },

        /**
         * Sets focus on the tagsinput
         */
        focus: function() {
            this.$input.focus();
        },

        /**
         * Returns the internal input element
         */
        input: function() {
            return this.$input;
        },

        /**
         * Returns the element which is wrapped around the internal input. This
         * is normally the $container, but typeahead.js moves the $input element.
         */
        findInputWrapper: function() {
            var elt = this.$input[0],
                container = this.$container[0];
            while (elt && elt.parentNode !== container)
                elt = elt.parentNode;

            return $(elt);
        }
    };

    /**
     * Register JQuery plugin
     */
    $.fn.tagsinput = function(arg1, arg2, arg3) {
        var results = [];

        this.each(function() {
            var tagsinput = $(this).data('tagsinput');
            // Initialize a new tags input
            if (!tagsinput) {
                tagsinput = new TagsInput(this, arg1);
                $(this).data('tagsinput', tagsinput);
                results.push(tagsinput);

                if (this.tagName === 'SELECT') {
                    $('option', $(this)).attr('selected', 'selected');
                }

                // Init tags from $(this).val()
                $(this).val($(this).val());
            } else if (!arg1 && !arg2) {
                // tagsinput already exists
                // no function, trying to init
                results.push(tagsinput);
            } else if (tagsinput[arg1] !== undefined) {
                // Invoke function on existing tags input
                if (tagsinput[arg1].length === 3 && arg3 !== undefined) {
                    var retVal = tagsinput[arg1](arg2, null, arg3);
                } else {
                    var retVal = tagsinput[arg1](arg2);
                }
                if (retVal !== undefined)
                    results.push(retVal);
            }
        });

        if (typeof arg1 == 'string') {
            // Return the results from the invoked function calls
            return results.length > 1 ? results : results[0];
        } else {
            return results;
        }
    };

    $.fn.tagsinput.Constructor = TagsInput;

    /**
     * Most options support both a string or number as well as a function as
     * option value. This function makes sure that the option with the given
     * key in the given options is wrapped in a function
     */
    function makeOptionItemFunction(options, key) {
        if (typeof options[key] !== 'function') {
            var propertyName = options[key];
            options[key] = function(item) { return item[propertyName]; };
        }
    }

    function makeOptionFunction(options, key) {
        if (typeof options[key] !== 'function') {
            var value = options[key];
            options[key] = function() { return value; };
        }
    }
    /**
     * HtmlEncodes the given value
     */
    var htmlEncodeContainer = $('<div />');

    function htmlEncode(value) {
        if (value) {
            return htmlEncodeContainer.text(value).html();
        } else {
            return '';
        }
    }

    /**
     * Returns the position of the caret in the given input field
     * http://flightschool.acylt.com/devnotes/caret-position-woes/
     */
    function doGetCaretPosition(oField) {
        var iCaretPos = 0;
        if (document.selection) {
            oField.focus();
            var oSel = document.selection.createRange();
            oSel.moveStart('character', -oField.value.length);
            iCaretPos = oSel.text.length;
        } else if (oField.selectionStart || oField.selectionStart == '0') {
            iCaretPos = oField.selectionStart;
        }
        return (iCaretPos);
    }

    /**
     * Returns boolean indicates whether user has pressed an expected key combination.
     * @param object keyPressEvent: JavaScript event object, refer
     *     http://www.w3.org/TR/2003/WD-DOM-Level-3-Events-20030331/ecma-script-binding.html
     * @param object lookupList: expected key combinations, as in:
     *     [13, {which: 188, shiftKey: true}]
     */
    function keyCombinationInList(keyPressEvent, lookupList) {
        var found = false;
        $.each(lookupList, function(index, keyCombination) {
            if (typeof(keyCombination) === 'number' && keyPressEvent.which === keyCombination) {
                found = true;
                return false;
            }

            if (keyPressEvent.which === keyCombination.which) {
                var alt = !keyCombination.hasOwnProperty('altKey') || keyPressEvent.altKey === keyCombination.altKey,
                    shift = !keyCombination.hasOwnProperty('shiftKey') || keyPressEvent.shiftKey === keyCombination.shiftKey,
                    ctrl = !keyCombination.hasOwnProperty('ctrlKey') || keyPressEvent.ctrlKey === keyCombination.ctrlKey;
                if (alt && shift && ctrl) {
                    found = true;
                    return false;
                }
            }
        });

        return found;
    }

    /**
     * Initialize tagsinput behaviour on inputs and selects which have
     * data-role=tagsinput
     */
    $(function() {
        $("input[data-role=tagsinput], select[multiple][data-role=tagsinput]").tagsinput();
    });
})(window.jQuery);
</script>
{%endblock container%}